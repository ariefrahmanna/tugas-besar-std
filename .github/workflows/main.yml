# .github/workflows/codeql.yml
name: "CodeQL Test"

on:
  pull_request: {}

jobs:
  analyze:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    strategy:
      matrix:
        language: [cpp] 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Build code
        run: |
          mkdir build
          cd build
          cmake ..
          make

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: codeql_result.sarif
      - name: Summarize CodeQL Findings in PR
        if: always()
        run: |
          if [[ -s codeql-results.sarif ]]; then
          {
            echo "### üîç CodeQL Findings"
            echo "<details><summary>Click to expand</summary>"
            echo ""
            echo '| Rule ID | Message | File | Line |'
            echo '|---------|---------|------|------|'
            jq -r '
              .runs[].results[] |
              "| \(.ruleId) | \(.message.text | gsub("\n"; " ")) | \(.locations[0].physicalLocation.artifactLocation.uri) | \(.locations[0].physicalLocation.region.startLine) |"
            ' codeql-results.sarif
            echo ""
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY
          fi
